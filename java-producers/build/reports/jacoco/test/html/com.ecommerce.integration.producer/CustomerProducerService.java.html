<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomerProducerService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java-producers</a> &gt; <a href="index.source.html" class="el_package">com.ecommerce.integration.producer</a> &gt; <span class="el_source">CustomerProducerService.java</span></div><h1>CustomerProducerService.java</h1><pre class="source lang-java linenums">package com.ecommerce.integration.producer;

import com.ecommerce.integration.client.MockApiClient;
import com.ecommerce.integration.model.Customer;
import com.ecommerce.integration.repository.SyncStateRepository;
import com.ecommerce.integration.service.KafkaProducerService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;

/**
 * Producer service for Customer data
 * Implements hybrid sync: initial full sync + incremental updates
 */
@Service
@RequiredArgsConstructor
<span class="fc" id="L21">@Slf4j</span>
public class CustomerProducerService {
    
    private static final String SOURCE_TYPE = &quot;CUSTOMER&quot;;
    
    private final MockApiClient apiClient;
    private final KafkaProducerService kafkaProducerService;
    private final SyncStateRepository syncStateRepository;
    
    /**
     * Scheduled sync job
     * Runs initial full sync on first execution, then incremental sync
     */
    @Scheduled(
        initialDelayString = &quot;${scheduling.customer-sync.initial-delay}&quot;,
        fixedDelayString = &quot;${scheduling.customer-sync.fixed-delay}&quot;
    )
    public void scheduledSync() {
<span class="nc" id="L39">        log.info(&quot;=== Starting scheduled customer sync ===&quot;);</span>
        
        try {
<span class="nc bnc" id="L42" title="All 2 branches missed.">            if (!syncStateRepository.isInitialSyncCompleted(SOURCE_TYPE)) {</span>
<span class="nc" id="L43">                log.info(&quot;Initial sync not completed. Performing full sync...&quot;);</span>
<span class="nc" id="L44">                performFullSync();</span>
            } else {
<span class="nc" id="L46">                log.info(&quot;Initial sync completed. Performing incremental sync...&quot;);</span>
<span class="nc" id="L47">                performIncrementalSync();</span>
            }
<span class="nc" id="L49">        } catch (Exception e) {</span>
<span class="nc" id="L50">            log.error(&quot;Error during scheduled customer sync&quot;, e);</span>
<span class="nc" id="L51">        }</span>
        
<span class="nc" id="L53">        log.info(&quot;=== Completed scheduled customer sync ===&quot;);</span>
<span class="nc" id="L54">    }</span>
    
    /**
     * Perform full sync - fetch all customers
     */
    public void performFullSync() {
<span class="fc" id="L60">        log.info(&quot;Starting FULL sync for customers&quot;);</span>
<span class="fc" id="L61">        LocalDateTime syncStartTime = LocalDateTime.now();</span>
        
        try {
            // Fetch all customers from API
<span class="fc" id="L65">            List&lt;Customer&gt; customers = apiClient.fetchAllCustomers();</span>
            
<span class="fc bfc" id="L67" title="All 2 branches covered.">            if (customers.isEmpty()) {</span>
<span class="fc" id="L68">                log.warn(&quot;No customers found during full sync&quot;);</span>
<span class="fc" id="L69">                return;</span>
            }
            
<span class="fc" id="L72">            log.info(&quot;Fetched {} customers. Publishing to Kafka...&quot;, customers.size());</span>
            
            // Publish to Kafka
<span class="fc" id="L75">            kafkaProducerService.sendCustomerData(</span>
                    customers,
                    &quot;INITIAL_FULL&quot;,
                    true,
<span class="fc" id="L79">                    customers.size()</span>
            );
            
            // Update sync state
<span class="fc" id="L83">            syncStateRepository.updateLastSyncTime(SOURCE_TYPE, syncStartTime, customers.size());</span>
            
<span class="fc" id="L85">            log.info(&quot;Full sync completed successfully. Synced {} customers&quot;, customers.size());</span>
            
<span class="fc" id="L87">        } catch (Exception e) {</span>
<span class="fc" id="L88">            log.error(&quot;Full sync failed for customers&quot;, e);</span>
<span class="fc" id="L89">            throw new RuntimeException(&quot;Full sync failed&quot;, e);</span>
<span class="fc" id="L90">        }</span>
<span class="fc" id="L91">    }</span>
    
    /**
     * Perform incremental sync - fetch only updated customers
     */
    public void performIncrementalSync() {
<span class="fc" id="L97">        log.info(&quot;Starting INCREMENTAL sync for customers&quot;);</span>
<span class="fc" id="L98">        LocalDateTime syncStartTime = LocalDateTime.now();</span>
        
        try {
            // Get last sync time
<span class="fc" id="L102">            LocalDateTime lastSyncTime = syncStateRepository.getLastSyncTime(SOURCE_TYPE)</span>
<span class="fc" id="L103">                    .orElse(LocalDateTime.now().minusMinutes(5)); // Default to 5 minutes ago</span>
            
<span class="fc" id="L105">            log.info(&quot;Fetching customers updated since: {}&quot;, lastSyncTime);</span>
            
            // Fetch only updated customers
<span class="fc" id="L108">            List&lt;Customer&gt; updatedCustomers = apiClient.fetchCustomersSince(lastSyncTime);</span>
            
<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (updatedCustomers.isEmpty()) {</span>
<span class="fc" id="L111">                log.info(&quot;No updated customers found since {}&quot;, lastSyncTime);</span>
                // Still update sync time even if no changes
<span class="fc" id="L113">                syncStateRepository.updateLastSyncTime(SOURCE_TYPE, syncStartTime, 0);</span>
<span class="fc" id="L114">                return;</span>
            }
            
<span class="fc" id="L117">            log.info(&quot;Found {} updated customers. Publishing to Kafka...&quot;, updatedCustomers.size());</span>
            
            // Publish to Kafka
<span class="fc" id="L120">            kafkaProducerService.sendCustomerData(</span>
                    updatedCustomers,
                    &quot;INCREMENTAL&quot;,
                    false,
<span class="fc" id="L124">                    updatedCustomers.size()</span>
            );
            
            // Update sync state
<span class="fc" id="L128">            syncStateRepository.updateLastSyncTime(SOURCE_TYPE, syncStartTime, updatedCustomers.size());</span>
            
<span class="fc" id="L130">            log.info(&quot;Incremental sync completed successfully. Synced {} customers&quot;, </span>
<span class="fc" id="L131">                    updatedCustomers.size());</span>
            
<span class="nc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            log.error(&quot;Incremental sync failed for customers&quot;, e);</span>
<span class="nc" id="L135">            throw new RuntimeException(&quot;Incremental sync failed&quot;, e);</span>
<span class="fc" id="L136">        }</span>
<span class="fc" id="L137">    }</span>
    
    /**
     * Manually trigger full sync (via REST endpoint)
     */
    public void triggerFullSync() {
<span class="nc" id="L143">        log.info(&quot;Manual full sync triggered for customers&quot;);</span>
<span class="nc" id="L144">        performFullSync();</span>
<span class="nc" id="L145">    }</span>
    
    /**
     * Manually trigger incremental sync (via REST endpoint)
     */
    public void triggerIncrementalSync() {
<span class="nc" id="L151">        log.info(&quot;Manual incremental sync triggered for customers&quot;);</span>
<span class="nc" id="L152">        performIncrementalSync();</span>
<span class="nc" id="L153">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>